<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å¤§é˜ªæ—…è¡ŒåŠ©æ‰‹ - æ¸…å–®ä¿®å¾©ç‰ˆ</title>
    <style>
        :root { --primary: #4f46e5; --bg: #f1f5f9; --card-bg: #ffffff; --text-main: #1e293b; --nav-bg: rgba(255, 255, 255, 0.95); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, "Noto Sans TC", sans-serif; }
        body { margin: 0; background-color: var(--bg); color: var(--text-main); padding-bottom: 120px; }
        .app-container { width: 100%; max-width: 500px; margin: 0 auto; min-height: 100vh; position: relative; }
        header { background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%); color: white; padding: 25px 20px 15px; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; position: sticky; top: 0; z-index: 100; }
        .tab-container { display: flex; background: rgba(255,255,255,0.2); border-radius: 12px; padding: 4px; margin-top: 15px; }
        .tab { flex: 1; padding: 10px; border-radius: 10px; font-size: 14px; font-weight: 800; border: none; color: white; background: transparent; cursor: pointer; }
        .tab.active { background: white; color: var(--primary); }
        .page-content { display: none; padding: 20px; animation: fadeIn 0.2s ease; }
        .page-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* å¡ç‰‡æ ¼å¼ä¿®æ­£ */
        .card { background: var(--card-bg); border-radius: 18px; padding: 15px; margin-bottom: 12px; display: flex; gap: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); align-items: center; cursor: pointer; border-left: 5px solid transparent; }
        .card.completed { border-left: 6px solid #22c55e; background: #f8fafc; opacity: 0.8; }
        
        /* Checkbox æ¨£å¼ */
        input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; flex-shrink: 0; accent-color: var(--primary); }

        nav.bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 500px; height: 90px; background: var(--nav-bg); backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #e2e8f0; z-index: 1000; padding-bottom: 15px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94a3b8; font-size: 12px; font-weight: 700; flex: 1; cursor: pointer; }
        .nav-item i { font-size: 24px; margin-bottom: 5px; }
        .nav-item.active { color: var(--primary); }
        
        .fab { position: fixed; right: 20px; bottom: 110px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; border: none; box-shadow: 0 6px 20px rgba(79,70,229,0.4); z-index: 99; }
        
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); display: none; align-items: flex-end; justify-content: center; z-index: 1100; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-top-left-radius: 30px; border-top-right-radius: 30px; padding: 25px; max-height: 85vh; overflow-y: auto; }
        input, select { border: 1.5px solid #e2e8f0; border-radius: 12px; padding: 14px; width: 100%; margin-bottom: 12px; font-size: 16px; outline: none; background: #f8fafc; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: 800; width: 100%; cursor: pointer; font-size: 16px; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div class="app-container">
    <header>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1 id="page-title" style="margin:0; font-size:22px; font-weight:900;">è¡Œç¨‹è¦åŠƒ</h1>
            <button onclick="fetchData()" style="background:none; border:none; color:white; font-size:20px;"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div class="tab-container" id="itinerary-tabs">
            <button class="tab active" id="tab-active" onclick="setTab('active')">é€²è¡Œä¸­</button>
            <button class="tab" id="tab-completed" onclick="setTab('completed')">å·²å®Œæˆ</button>
        </div>
    </header>

    <main id="page-itinerary" class="page-content active"><div id="itinerary-list">è®€å–ä¸­...</div></main>
    <main id="page-money" class="page-content">
        <div style="background:#1e293b; color:white; padding:20px; border-radius:20px; margin-bottom:15px;">
            <small>ç¸½æ”¯å‡ºé ç®—</small>
            <h2 style="margin:5px 0;">Â¥ <span id="total-jpy">0</span></h2>
            <div style="color:#22c55e; font-weight:bold;">â‰ˆ NT$ <span id="total-twd">0</span></div>
        </div>
        <div id="expense-list"></div>
    </main>
    <main id="page-check" class="page-content"><div id="check-list"></div></main>
    <main id="page-files" class="page-content">
        <div class="card" onclick="window.open('https://drive.google.com/drive/folders/1_uH76mAtBVkm8wttpyeG0T9g5st6jDm4')">
            <i class="fas fa-folder-open" style="font-size:24px; color:#f59e0b;"></i>
            <b>é›²ç«¯æ–‡ä»¶å¤¾ (è¡Œç¨‹è¡¨/ç¥¨åˆ¸)</b>
        </div>
    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('itinerary', this)"><i class="fas fa-calendar-alt"></i><span>è¡Œç¨‹</span></div>
        <div class="nav-item" onclick="switchPage('money', this)"><i class="fas fa-yen-sign"></i><span>è¨˜å¸³</span></div>
        <div class="nav-item" onclick="switchPage('check', this)"><i class="fas fa-check-square"></i><span>æ¸…å–®</span></div>
        <div class="nav-item" onclick="switchPage('files', this)"><i class="fas fa-file-alt"></i><span>æ–‡ä»¶</span></div>
    </nav>

    <button id="fab-btn" class="fab" onclick="openItineraryModal()"><i class="fas fa-plus"></i></button>

    <div id="itinerary-modal" class="modal"><div class="modal-content">
        <h3 id="it-modal-title">ç·¨è¼¯è¡Œç¨‹</h3>
        <input id="in-date" type="text" placeholder="æ—¥æœŸ (1/11)">
        <input id="in-time" type="text" placeholder="æ™‚é–“ (12:00)">
        <input id="in-activity" type="text" placeholder="æ´»å‹•é …ç›®">
        <input id="in-location" type="text" placeholder="åœ°é»åç¨±">
        <input id="in-image" type="text" placeholder="åœ–ç‰‡ç¶²å€">
        <div style="display:flex; gap:10px;">
            <button id="it-del-btn" onclick="submitItinerary('delete')" style="flex:1; background:#fee2e2; color:#ef4444; border:none; border-radius:12px; font-weight:bold;">åˆªé™¤</button>
            <button class="btn-primary" style="flex:2;" onclick="submitItinerary('save')">å„²å­˜è¡Œç¨‹</button>
        </div>
        <button onclick="closeModals()" style="width:100%; background:none; border:none; color:#94a3b8; margin-top:15px;">å–æ¶ˆ</button>
    </div></div>

    <div id="expense-modal" class="modal"><div class="modal-content">
        <h3>è¨˜å¸³ç®¡ç†</h3>
        <input id="ex-twd" type="number" placeholder="è¼¸å…¥å°å¹£è‡ªå‹•æ›ç®—" oninput="document.getElementById('ex-amount').value=Math.round(this.value/0.21)">
        <input id="ex-amount" type="number" placeholder="æ—¥å¹£é‡‘é¡ (JPY)">
        <input id="ex-act" type="text" placeholder="æ¶ˆè²»å…§å®¹">
        <select id="ex-cat"><option value="é¤é£²">ğŸ± é¤é£²</option><option value="äº¤é€š">ğŸšƒ äº¤é€š</option><option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option><option value="å…¶ä»–">â“ å…¶ä»–</option></select>
        <div style="display:flex; gap:10px;">
            <button id="ex-del-btn" onclick="submitExpense('deleteExpense')" style="flex:1; background:#fee2e2; color:#ef4444; border:none; border-radius:12px; font-weight:bold;">åˆªé™¤</button>
            <button class="btn-primary" style="flex:2;" onclick="submitExpense()">å„²å­˜æ”¯å‡º</button>
        </div>
        <button onclick="closeModals()" style="width:100%; background:none; border:none; color:#94a3b8; margin-top:15px;">å–æ¶ˆ</button>
    </div></div>

    <div id="check-modal" class="modal"><div class="modal-content">
        <h3 id="ck-modal-title">æ¸…å–®é …ç›®</h3>
        <input id="ck-item" type="text" placeholder="æº–å‚™é …ç›®">
        <input id="ck-owner" type="text" placeholder="è² è²¬äºº">
        <div style="display:flex; gap:10px;">
            <button id="ck-del-btn" onclick="deleteCheck()" style="flex:1; background:#fee2e2; color:#ef4444; border:none; border-radius:12px; font-weight:bold;">åˆªé™¤</button>
            <button class="btn-primary" style="flex:2;" onclick="submitCheck()">ç¢ºèªå„²å­˜</button>
        </div>
        <button onclick="closeModals()" style="width:100%; background:none; border:none; color:#94a3b8; margin-top:15px;">å–æ¶ˆ</button>
    </div></div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyb1gSGdB4_OTp_Nzl699EBDaLvIAEJ1pU42wld_bxxa8Fl7fpqMEXG81mpzMpNKeOh4w/exec";
    const RATE = 0.21;
    let allData = { itinerary: [], expenses: [], checklist: [] }, currentTab = 'active', editingIt = null, editingEx = null, editingCk = null;

    async function fetchData() {
        try {
            const res = await fetch(API_URL + "?t=" + Date.now());
            const data = await res.json();
            const now = new Date();
            
            allData.itinerary = (data.itinerary || []).slice(1).filter(r => r[2]).map(r => {
                const processDateTime = (val, isTime) => {
                    if (!val) return "";
                    let d = new Date(val);
                    if (isNaN(d.getTime())) return String(val);
                    if (d.getFullYear() < 1970 && isTime) return d.toLocaleTimeString('zh-TW', {hour12:false, hour:'2-digit', minute:'2-digit'});
                    return isTime ? d.toLocaleTimeString('zh-TW', {hour12:false, hour:'2-digit', minute:'2-digit'}) : (d.getMonth()+1)+"/"+d.getDate();
                };
                let dStr = processDateTime(r[0], false), tStr = processDateTime(r[1], true);
                let score = 99999999, dMatch = dStr.match(/(\d+)\/(\d+)/);
                if (dMatch) score = parseInt(dMatch[1].padStart(2, '0') + dMatch[2].padStart(2, '0') + (tStr.replace(':','') || "0000"));
                let isPast = dMatch ? new Date(2026, dMatch[1]-1, dMatch[2]) < now : false;
                return { date: dStr||"å¾…å®š", time: tStr||"æœªå®š", activity: r[2], location: r[3]||"æœªå®š", image: r[4], sortScore: score, isPast };
            }).sort((a,b) => a.sortScore - b.sortScore);
            
            allData.expenses = (data.expenses || []).slice(1).reverse();
            allData.checklist = (data.checklist || []).slice(1);
            renderAll();
        } catch (e) { console.error(e); }
    }

    function renderAll() {
        // è¡Œç¨‹
        const itList = allData.itinerary.filter(i => currentTab === 'active' ? !i.isPast : i.isPast);
        document.getElementById('itinerary-list').innerHTML = itList.map(i => `
            <div class="card" onclick='openItineraryModal(${JSON.stringify(i)})'>
                <div style="width:65px; height:65px; flex-shrink:0; position:relative;">
                    <div style="position:absolute; top:-5px; left:-5px; background:var(--primary); color:white; padding:2px 6px; border-radius:8px; font-size:10px; font-weight:bold;">${i.date}</div>
                    <img src="${i.image || 'https://via.placeholder.com/65/4f46e5/ffffff?text=OSAKA'}" style="width:100%; height:100%; border-radius:12px; object-fit:cover;">
                </div>
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between;"><b>${i.activity}</b><span style="color:var(--primary); font-weight:800;">${i.time}</span></div>
                    <small style="color:#94a3b8;" onclick="event.stopPropagation(); window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.location)}', '_blank')">ğŸ“ ${i.location} (å°èˆª)</small>
                </div>
            </div>`).join('');

        // è¨˜å¸³
        const total = allData.expenses.reduce((s, r) => s + (parseFloat(r[3]) || 0), 0);
        document.getElementById('total-jpy').innerText = total.toLocaleString();
        document.getElementById('total-twd').innerText = Math.round(total * RATE).toLocaleString();
        document.getElementById('expense-list').innerHTML = allData.expenses.map(e => `
            <div class="card" style="justify-content:space-between;" onclick='openExpenseModal({cat:"${e[1]}", act:"${e[2]}", amt:${e[3]}})'>
                <div><b>${e[2]}</b><br><small>${e[1]}</small></div>
                <div style="text-align:right;"><b>Â¥${(parseFloat(e[3])||0).toLocaleString()}</b><br><small style="color:#94a3b8; font-size:11px;">â‰ˆ NT$${Math.round(e[3]*RATE)}</small></div>
            </div>`).join('');

        // æ¸…å–® (ä¿®æ­£æ’ç‰ˆèˆ‡ç·¨è¼¯é»æ“Š)
        document.getElementById('check-list').innerHTML = allData.checklist.map(c => {
            const isDone = String(c[2]).toUpperCase()==='TRUE';
            return `<div class="card ${isDone?'completed':''}" onclick="openCheckModal('${c[0]}', '${c[1]}')">
                <input type="checkbox" ${isDone?'checked':''} onclick="event.stopPropagation(); toggleCheck('${c[0]}', ${!isDone})">
                <div style="flex:1;">
                    <b style="${isDone?'text-decoration:line-through;color:#94a3b8;':''}">${c[0]}</b>
                    <div style="font-size:12px; color:var(--primary);">ğŸ‘¤ ${c[1]||'å¾…å®š'}</div>
                </div>
                <i class="fas fa-chevron-right" style="color:#e2e8f0; font-size:12px;"></i>
            </div>`;
        }).join('');
    }

    function switchPage(p, el) {
        document.querySelectorAll('.page-content').forEach(pc => pc.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(ni => ni.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('page-title').innerText = {itinerary:'è¡Œç¨‹è¦åŠƒ', money:'è¨˜å¸³æœ¬', check:'æ¸…å–®', files:'æ–‡ä»¶åº«'}[p];
        document.getElementById('itinerary-tabs').style.display = p === 'itinerary' ? 'flex' : 'none';
        const fab = document.getElementById('fab-btn');
        fab.style.display = p === 'files' ? 'none' : 'flex';
        fab.onclick = p==='itinerary' ? openItineraryModal : (p==='money' ? openExpenseModal : () => openCheckModal());
    }

    function openItineraryModal(i=null) { editingIt=i; document.getElementById('itinerary-modal').style.display='flex'; document.getElementById('it-del-btn').style.display=i?"block":"none"; document.getElementById('in-date').value=i?i.date:''; document.getElementById('in-time').value=i?i.time:''; document.getElementById('in-activity').value=i?i.activity:''; document.getElementById('in-location').value=i?i.location:''; document.getElementById('in-image').value=i?i.image:''; }
    function openExpenseModal(e=null) { editingEx=e; document.getElementById('expense-modal').style.display='flex'; document.getElementById('ex-del-btn').style.display=e?"block":"none"; document.getElementById('ex-amount').value=e?e.amt:''; document.getElementById('ex-act').value=e?e.act:''; document.getElementById('ex-cat').value=e?e.cat:'é¤é£²'; document.getElementById('ex-twd').value=''; }
    function openCheckModal(item='', owner='') { editingCk=item; document.getElementById('check-modal').style.display='flex'; document.getElementById('ck-modal-title').innerText=item?"ç·¨è¼¯æ¸…å–®":"æ–°å¢é …ç›®"; document.getElementById('ck-del-btn').style.display=item?"block":"none"; document.getElementById('ck-item').value=item; document.getElementById('ck-owner').value=owner; }
    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }

    async function submitItinerary(type) { 
        let action = type==='delete'?'delete':(editingIt?'edit':'add');
        const data = { action, date: document.getElementById('in-date').value, time: document.getElementById('in-time').value, activity: document.getElementById('in-activity').value, location: document.getElementById('in-location').value, image: document.getElementById('in-image').value, oldActivity: editingIt?editingIt.activity:null };
        closeModals(); await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) }); setTimeout(fetchData, 1500);
    }
    async function submitExpense(type=null) {
        const data = { type: type||(editingEx?'editExpense':'expense'), category: document.getElementById('ex-cat').value, activity: document.getElementById('ex-act').value, amount: document.getElementById('ex-amount').value, oldActivity: editingEx?editingEx.act:null };
        closeModals(); await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) }); setTimeout(fetchData, 1500);
    }
    async function submitCheck() {
        const item = document.getElementById('ck-item').value, owner = document.getElementById('ck-owner').value;
        if(!item) return; closeModals(); 
        const type = editingCk ? 'editCheck' : 'addCheck'; // éœ€ç¢ºèªå¾Œç«¯æœ‰ç„¡ editCheckï¼Œè‹¥ç„¡å‰‡å…ˆ add å†æ‰‹å‹•åˆªé™¤
        await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ type, item, owner, oldItem: editingCk }) }); setTimeout(fetchData, 1200);
    }
    async function deleteCheck() { if(!editingCk) return; closeModals(); await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ type: 'deleteCheck', item: editingCk }) }); setTimeout(fetchData, 1200); }
    async function toggleCheck(item, status) { await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ type: 'toggleCheck', item, status }) }); setTimeout(fetchData, 500); }
    function setTab(t) { currentTab=t; document.getElementById('tab-active').classList.toggle('active', t==='active'); document.getElementById('tab-completed').classList.toggle('active', t==='completed'); renderAll(); }
    window.onload = fetchData;
</script>
</body>
</html>
