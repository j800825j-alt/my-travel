<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å¤§é˜ªæ—…è¡ŒåŠ©æ‰‹</title>
    <style>
        :root { --primary: #4f46e5; --bg: #f1f5f9; --card-bg: #ffffff; --text-main: #1e293b; --nav-bg: rgba(255, 255, 255, 0.95); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, "Noto Sans TC", sans-serif; }
        body { margin: 0; background-color: var(--bg); color: var(--text-main); padding-bottom: 90px; }
        .app-container { width: 100%; max-width: 500px; margin: 0 auto; min-height: 100vh; position: relative; }
        header { background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%); color: white; padding: 25px 20px 15px; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; position: sticky; top: 0; z-index: 100; }
        .tab-container { display: flex; background: rgba(255,255,255,0.2); border-radius: 12px; padding: 4px; margin-top: 15px; }
        .tab { flex: 1; padding: 10px; border-radius: 10px; font-size: 14px; font-weight: 800; border: none; color: white; background: transparent; cursor: pointer; }
        .tab.active { background: white; color: var(--primary); }
        .page-content { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .page-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--card-bg); border-radius: 20px; padding: 12px; margin-bottom: 12px; display: flex; gap: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); align-items: center; cursor: pointer; }
        .card.is-gray { opacity: 0.5; filter: grayscale(0.8); background: #f8fafc; }
        .card-media { position: relative; width: 70px; height: 70px; flex-shrink: 0; }
        .card-img { width: 100%; height: 100%; border-radius: 12px; object-fit: cover; background: #e2e8f0; }
        .date-badge { position: absolute; top: -5px; left: -5px; background: var(--primary); color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 800; }
        .time-label { font-size: 11px; color: var(--primary); font-weight: 800; background: #eef2ff; padding: 2px 6px; border-radius: 6px; }
        nav.bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 500px; height: 75px; background: var(--nav-bg); backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #e2e8f0; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94a3b8; font-size: 10px; font-weight: 700; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .fab { position: fixed; right: 20px; bottom: 95px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: none; box-shadow: 0 4px 15px rgba(79,70,229,0.4); z-index: 90; }
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); display: none; align-items: flex-end; justify-content: center; z-index: 1100; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-top-left-radius: 30px; border-top-right-radius: 30px; padding: 25px 20px; max-height: 90vh; overflow-y: auto; }
        input, select { border: 1.5px solid #e2e8f0; border-radius: 12px; padding: 12px; width: 100%; margin-bottom: 12px; font-size: 14px; outline: none; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: 800; width: 100%; cursor: pointer; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div class="app-container">
    <header>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1 id="page-title" style="margin:0; font-size:20px; font-weight:900;">è¡Œç¨‹è¦åŠƒ</h1>
            <button onclick="fetchData()" style="background:none; border:none; color:white; font-size:18px;"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div class="tab-container" id="itinerary-tabs">
            <button class="tab active" id="tab-active" onclick="setTab('active')">é€²è¡Œä¸­</button>
            <button class="tab" id="tab-completed" onclick="setTab('completed')">å·²å®Œæˆ</button>
        </div>
    </header>

    <main id="page-itinerary" class="page-content active"><div id="itinerary-list">è®€å–ä¸­...</div></main>
    <main id="page-money" class="page-content">
        <div style="background:#1e293b; color:white; padding:20px; border-radius:20px; margin-bottom:15px;">
            <small>ç¸½æ”¯å‡º (åŒ¯ç‡ 0.21)</small>
            <h2 style="margin:5px 0;">Â¥ <span id="total-jpy">0</span></h2>
            <div style="color:#22c55e; font-weight:bold;">â‰ˆ NT$ <span id="total-twd">0</span></div>
        </div>
        <div id="expense-list"></div>
    </main>
    <main id="page-files" class="page-content"><div id="file-list"></div></main>
    <main id="page-contacts" class="page-content">
        <div class="card" onclick="window.location.href='tel:110'"><i class="fas fa-phone-alt"></i><div><b>æ—¥æœ¬å ±è­¦ (110)</b></div></div>
        <div class="card" onclick="window.location.href='tel:0664438481'"><i class="fas fa-building"></i><div><b>å°åŒ—é§å¤§é˜ªè¾¦äº‹è™•</b></div></div>
    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('itinerary', this)"><i class="fas fa-calendar-alt"></i><span>è¡Œç¨‹</span></div>
        <div class="nav-item" onclick="switchPage('money', this)"><i class="fas fa-yen-sign"></i><span>è¨˜å¸³</span></div>
        <div class="nav-item" onclick="switchPage('files', this)"><i class="fas fa-file-alt"></i><span>æ–‡ä»¶</span></div>
        <div class="nav-item" onclick="switchPage('contacts', this)"><i class="fas fa-address-book"></i><span>è¯çµ¡</span></div>
    </nav>

    <button id="fab-btn" class="fab" onclick="openItineraryModal()"><i class="fas fa-plus"></i></button>

    <div id="itinerary-modal" class="modal"><div class="modal-content">
        <h3 id="it-title">æ–°å¢/ç·¨è¼¯è¡Œç¨‹</h3>
        <input id="in-date" type="text" placeholder="æ—¥æœŸ (å¦‚: 1/10)">
        <input id="in-time" type="text" placeholder="æ™‚é–“ (å¦‚: 12:00)">
        <input id="in-activity" type="text" placeholder="æ´»å‹•å…§å®¹">
        <input id="in-location" type="text" placeholder="åœ°é»">
        <input id="in-image" type="text" placeholder="åœ–ç‰‡é€£çµ (ä¸Šå‚³å¾Œè‡ªå‹•å¡«å…¥)">
        <button onclick="document.getElementById('it-file').click()" style="width:100%; padding:10px; margin-bottom:10px; border-radius:10px; border:1px dashed var(--primary); background:none; color:var(--primary); font-weight:bold;">ğŸ“· æ‹ç…§æˆ–é¸å–ç…§ç‰‡</button>
        <input type="file" id="it-file" style="display:none;" accept="image/*" onchange="uploadFile(this, 'it')">
        <div id="it-up-status" style="display:none; text-align:center; color:var(--primary); font-size:12px; margin-bottom:10px;"></div>
        <div style="display:flex; gap:10px;">
            <button id="it-del-btn" onclick="submitItinerary('delete')" style="flex:1; background:#fee2e2; color:#ef4444; border:none; padding:15px; border-radius:12px; font-weight:bold;">åˆªé™¤</button>
            <button class="btn-primary" style="flex:2;" onclick="submitItinerary()">å„²å­˜è¡Œç¨‹</button>
        </div>
        <button onclick="closeModals()" style="width:100%; background:none; border:none; color:#94a3b8; margin-top:15px;">å–æ¶ˆ</button>
    </div></div>

    <div id="expense-modal" class="modal"><div class="modal-content">
        <h3 id="ex-title">æ–°å¢è¨˜å¸³</h3>
        <input id="ex-amount" type="number" placeholder="é‡‘é¡ (æ—¥å¹£)">
        <input id="ex-act" type="text" placeholder="é …ç›®å…§å®¹">
        <select id="ex-cat"><option value="é¤é£²">ğŸ± é¤é£²</option><option value="äº¤é€š">ğŸšƒ äº¤é€š</option><option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option><option value="å…¶ä»–">â“ å…¶ä»–</option></select>
        <div style="display:flex; gap:10px;">
            <button id="ex-del-btn" onclick="submitExpense('deleteExpense')" style="flex:1; background:#fee2e2; color:#ef4444; border:none; padding:15px; border-radius:12px; font-weight:bold;">åˆªé™¤</button>
            <button class="btn-primary" style="flex:2;" onclick="submitExpense()">å„²å­˜æ”¯å‡º</button>
        </div>
        <button onclick="closeModals()" style="width:100%; background:none; border:none; color:#94a3b8; margin-top:15px;">å–æ¶ˆ</button>
    </div></div>

    <div id="file-modal" class="modal"><div class="modal-content">
        <h3>ä¸Šå‚³æ–°æ–‡ä»¶ (PDF/åœ–æª”)</h3>
        <input id="doc-name-input" type="text" placeholder="æ–‡ä»¶åç¨± (å¦‚ï¼šä¿éšªå–®)">
        <button onclick="document.getElementById('doc-file').click()" style="width:100%; padding:30px; border:2px dashed #cbd5e1; border-radius:15px; color:#64748b; font-weight:bold;">é¸æ“‡æª”æ¡ˆ</button>
        <input type="file" id="doc-file" style="display:none;" onchange="uploadFile(this, 'doc')">
        <div id="doc-up-status" style="display:none; text-align:center; color:var(--primary); font-size:12px; margin-top:10px;"></div>
        <button onclick="closeModals()" style="width:100%; background:none; border:none; color:#94a3b8; margin-top:15px;">å–æ¶ˆ</button>
    </div></div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyb1gSGdB4_OTp_Nzl699EBDaLvIAEJ1pU42wld_bxxa8Fl7fpqMEXG81mpzMpNKeOh4w/exec";
    let allData = { itinerary: [], expenses: [], files: [] }, currentTab = 'active', editingIt = null, editingEx = null;

    async function fetchData() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            const now = new Date();
            
            allData.itinerary = (data.itinerary || []).slice(1).map(row => {
                const parts = String(row[0]).split('/');
                const timeParts = String(row[1] || "00:00").split(':');
                const d = new Date(2026, parseInt(parts[0])-1, parseInt(parts[1]), parseInt(timeParts[0]), parseInt(timeParts[1]));
                return { date: row[0], time: row[1], activity: row[2], location: row[3], image: row[4], dateObj: d, isPast: d < now };
            }).sort((a,b) => a.dateObj - b.dateObj);

            allData.expenses = (data.expenses || []).slice(1).reverse();
            allData.files = (data.files || []).slice(1).reverse();
            renderAll();
        } catch (e) { console.error("Fetch error:", e); }
    }

    function renderAll() {
        document.getElementById('itinerary-list').innerHTML = allData.itinerary.filter(i => currentTab === 'active' ? !i.isPast : i.isPast).map(i => `
            <div class="card ${i.isPast ? 'is-gray' : ''}" onclick='openItineraryModal(${JSON.stringify(i)})'>
                <div class="card-media"><div class="date-badge">${i.date}</div><img src="${i.image || 'https://via.placeholder.com/70'}" class="card-img"></div>
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between;"><b>${i.activity}</b><span class="time-label">${i.time}</span></div>
                    <small style="color:#94a3b8;"><i class="fas fa-map-marker-alt"></i> ${i.location}</small>
                </div>
            </div>`).join('');
        
        const total = allData.expenses.reduce((s, r) => s + (parseFloat(r[3]) || 0), 0);
        document.getElementById('total-jpy').innerText = total.toLocaleString();
        document.getElementById('total-twd').innerText = Math.round(total * 0.21).toLocaleString();
        document.getElementById('expense-list').innerHTML = allData.expenses.map(e => `
            <div class="card" style="justify-content:space-between;" onclick='openExpenseModal({date:"${e[0]}", cat:"${e[1]}", act:"${e[2]}", amt:${e[3]}})'>
                <div><b>${e[2]}</b><br><small>${e[1]} â€¢ ${e[0]}</small></div>
                <b>Â¥${e[3]}</b>
            </div>`).join('');

        document.getElementById('file-list').innerHTML = allData.files.map(f => `
            <div class="card" onclick="window.open('${f[1]}')">
                <i class="fas fa-file-pdf" style="font-size:24px; color:#ef4444;"></i>
                <div style="flex:1;"><b>${f[0]}</b><br><small>${f[3]}</small></div>
                <i class="fas fa-external-link-alt" style="color:#cbd5e1;"></i>
            </div>`).join('');
    }

    async function uploadFile(input, type) {
        const file = input.files[0]; if(!file) return;
        const statusId = type === 'it' ? 'it-up-status' : 'doc-up-status';
        const statusEl = document.getElementById(statusId);
        statusEl.style.display = 'block';
        statusEl.innerHTML = "â³ æ­£åœ¨ä¸Šå‚³è‡³é›²ç«¯...";
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            const payload = { 
                type: 'upload', 
                base64: e.target.result, 
                filename: file.name,
                subType: type === 'doc' ? 'doc' : 'img',
                docName: type === 'doc' ? document.getElementById('doc-name-input').value : ''
            };
            
            try {
                const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
                const result = await res.json();
                statusEl.innerHTML = "âœ… ä¸Šå‚³æˆåŠŸï¼";
                if(type === 'it') document.getElementById('in-image').value = result.url;
                else setTimeout(() => { closeModals(); fetchData(); }, 1500);
            } catch (err) { statusEl.innerHTML = "âŒ ä¸Šå‚³å¤±æ•—"; }
        };
        reader.readAsDataURL(file);
    }

    function switchPage(p, el) {
        document.querySelectorAll('.page-content').forEach(pc => pc.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(ni => ni.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('itinerary-tabs').style.display = p === 'itinerary' ? 'flex' : 'none';
        document.getElementById('fab-btn').style.display = p === 'contacts' ? 'none' : 'flex';
        document.getElementById('fab-btn').onclick = p === 'itinerary' ? () => openItineraryModal() : p === 'money' ? () => openExpenseModal() : () => openFileModal();
    }

    function openItineraryModal(item = null) {
        editingIt = item;
        document.getElementById('itinerary-modal').style.display = 'flex';
        document.getElementById('it-del-btn').style.display = item ? 'block' : 'none';
        if(item) {
            document.getElementById('in-date').value = item.date;
            document.getElementById('in-time').value = item.time;
            document.getElementById('in-activity').value = item.activity;
            document.getElementById('in-location').value = item.location;
            document.getElementById('in-image').value = item.image;
        } else { document.querySelectorAll('#itinerary-modal input').forEach(i => i.value = ''); }
    }

    async function submitItinerary(action = null) {
        const data = { 
            action: action || (editingIt ? 'edit' : 'add'), 
            date: document.getElementById('in-date').value, 
            time: document.getElementById('in-time').value, 
            activity: document.getElementById('in-activity').value, 
            location: document.getElementById('in-location').value, 
            image: document.getElementById('in-image').value, 
            oldActivity: editingIt ? editingIt.activity : null 
        };
        closeModals();
        await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) });
        setTimeout(fetchData, 1500);
    }

    function openExpenseModal(item = null) {
        editingEx = item;
        document.getElementById('expense-modal').style.display = 'flex';
        document.getElementById('ex-del-btn').style.display = item ? 'block' : 'none';
        if(item) {
            document.getElementById('ex-amount').value = item.amt;
            document.getElementById('ex-act').value = item.act;
            document.getElementById('ex-cat').value = item.cat;
        } else { document.getElementById('ex-amount').value = ''; document.getElementById('ex-act').value = ''; }
    }

    async function submitExpense(type = null) {
        const data = { 
            type: type || (editingEx ? 'editExpense' : 'expense'), 
            date: new Date().toLocaleDateString(), 
            category: document.getElementById('ex-cat').value, 
            activity: document.getElementById('ex-act').value, 
            amount: document.getElementById('ex-amount').value, 
            oldActivity: editingEx ? editingEx.act : null 
        };
        closeModals();
        await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) });
        setTimeout(fetchData, 1000);
    }

    function openFileModal() { document.getElementById('file-modal').style.display = 'flex'; }
    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    function setTab(t) { currentTab = t; document.getElementById('tab-active').classList.toggle('active', t==='active'); document.getElementById('tab-completed').classList.toggle('active', t==='completed'); renderAll(); }
    window.onload = fetchData;
</script>
</body>
</html>